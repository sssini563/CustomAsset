# Build a derived image from the official Snipe-IT image and bake in our customizations
# This avoids bind mounts and vendor mismatches while keeping the upstream runtime/entrypoint.

ARG SNIPE_IT_TAG=8.3.3
FROM snipe/snipe-it:${SNIPE_IT_TAG}

# PHP memory/upload overrides (support both Debian and official PHP layout)
COPY docker/php-custom.ini /etc/php/8.3/apache2/conf.d/99-custom.ini
COPY docker/php-custom.ini /etc/php/8.3/cli/conf.d/99-custom.ini
COPY docker/php-custom.ini /usr/local/etc/php/conf.d/99-custom.ini

# Copy selective custom application code
COPY app/Http/Controllers/Documents /var/www/html/app/Http/Controllers/Documents
COPY app/Http/Controllers/SettingsController.php /var/www/html/app/Http/Controllers/SettingsController.php
COPY app/Models/Document.php /var/www/html/app/Models/Document.php
COPY app/Models/DocumentSignature.php /var/www/html/app/Models/DocumentSignature.php
COPY app/Policies/DocumentPolicy.php /var/www/html/app/Policies/DocumentPolicy.php
COPY app/Providers/AuthServiceProvider.php /var/www/html/app/Providers/AuthServiceProvider.php
COPY app/Services/DocumentNumberGenerator.php /var/www/html/app/Services/DocumentNumberGenerator.php

# Views and routes used by the custom Documents module
COPY resources/views/documents /var/www/html/resources/views/documents
COPY routes/web.php /var/www/html/routes/web.php
COPY routes/api.php /var/www/html/routes/api.php

# Ensure ownership for web user and keep permissions sane
RUN chown -R www-data:www-data \
    /var/www/html/app/Http/Controllers/Documents \
    /var/www/html/app/Http/Controllers/SettingsController.php \
    /var/www/html/app/Models/Document.php \
    /var/www/html/app/Models/DocumentSignature.php \
    /var/www/html/app/Policies/DocumentPolicy.php \
    /var/www/html/app/Providers/AuthServiceProvider.php \
    /var/www/html/app/Services/DocumentNumberGenerator.php \
    /var/www/html/resources/views/documents \
    /var/www/html/routes/web.php \
    /var/www/html/routes/api.php

# Do NOT run artisan here (no DB at build-time). The upstream entrypoint handles caching/migrations.
